%!TEX root = fusion.tex

\begin{figure}
\begin{minted}{Haskell}
instance Functor Graph where
  fmap f = 
    foldg Empty (Vertex . f) Overlay Connect

instance Applicative Graph where
  pure = Vertex
  (<*>) = f >>= (<$> x)

instance Monad Graph where
  return = pure
  g (>>=) f = foldg Empty f Overlay Connect

foldg :: b -> (a -> b)
      -> (b -> b -> b)  -> (b -> b -> b) 
      -> Graph a -> b
foldg e v o c = go
  where
    go Empty = e
    go (Vertex x) = v x
    go (Overlay a b) = o (go a) (go b)
    go (Connect a b) = c (go a) (go b)

paragraph :: b -> (a -> b) 
          -> (b -> b -> Graph a -> Graph a -> b)
          -> (b -> b -> Graph a -> Graph a -> b)
          -> Graph a -> b
paragraph e v o c = go
  where
    go Empty = e
    go (Vertex x) = v x
    go (Overlay a b) = o (go a) (go b) a b
    go (Connect a b) = c (go a) (go b) a b
  
hasVertex :: Eq a => a -> Graph a -> Bool
hasVertex s = foldg False ((==) s) (||) (||)

data Hit = Miss | Tail | Edge 
  deriving (Eq, Ord)
hasEdge :: Eq a => a -> a -> Graph a -> Bool
hasEdge s t g = (paragraph e v o c g) == Edge
  where
    e = Miss
    v x = if x == s then Tail else Miss
    o _ _ x y = case x of
      Miss -> y
      Tail -> max Tail y
      Edge -> Edge
      c _ b x y = case x of
      Miss -> y
      Tail -> 
        if hasVertex t b then Edge else Tail
      Edge -> Edge
\end{minted}
\caption{A part of the Alga API}
\label{fig:alga}
\end{figure}
